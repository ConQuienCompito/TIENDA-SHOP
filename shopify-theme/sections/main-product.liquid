<section class="product-page">
  <div class="page-width">
    <div class="product-page__container">
      <div class="product-page__gallery">
        <div class="product-page__main-image">
          {%- if product.featured_image -%}
            <img id="main-product-image" src="{{ product.featured_image | image_url: width: 800 }}" alt="{{ product.title | escape }}" loading="eager" fetchpriority="high">
          {%- else -%}
            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
          {%- endif -%}
          <div class="product-page__glow"></div>
        </div>
        {%- if product.images.size > 1 -%}
          <div class="product-page__thumbs">
            {%- for image in product.images limit: 5 -%}
              <button class="product-page__thumb{% if forloop.first %} active{% endif %}" onclick="document.getElementById('main-product-image').src='{{ image | image_url: width: 800 }}';document.querySelectorAll('.product-page__thumb').forEach(t=>t.classList.remove('active'));this.classList.add('active');" type="button" aria-label="Ver imagen {{ forloop.index }}">
                <img src="{{ image | image_url: width: 100 }}" alt="{{ product.title | escape }}" loading="lazy">
              </button>
            {%- endfor -%}
          </div>
        {%- endif -%}
      </div>
      
      <div class="product-page__info">
        {%- if section.settings.show_badges -%}
          <div class="product-page__badges">
            <span class="badge badge--success"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> En stock</span>
            <span class="badge badge--info"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon></svg> Envío rápido</span>
          </div>
        {%- endif -%}
        
        <p class="product-page__brand">LUMEI</p>
        <h1 class="product-page__title">{{ product.title }}</h1>
        
        {%- if section.settings.show_rating -%}
          <div class="product-page__rating">
            <div class="stars">{%- for i in (1..5) -%}<svg width="16" height="16" viewBox="0 0 24 24" fill="#fbbf24" stroke="#fbbf24" stroke-width="1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>{%- endfor -%}</div>
            <span>4.9/5</span>
          </div>
        {%- endif -%}
        
        <div class="product-page__price">
          {%- if product.compare_at_price > product.price -%}
            <span class="product-page__price-compare">{{ product.compare_at_price | money }}</span>
          {%- endif -%}
          <span class="product-page__price-current">{{ product.price | money }}</span>
        </div>
        
        {%- form 'product', product, id: 'product-form' -%}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" id="product-variant-id">
          
          {%- unless product.has_only_default_variant -%}
            {%- for option in product.options_with_values -%}
              <div class="product-page__option">
                <label class="product-page__option-label" for="option-{{ forloop.index }}">{{ option.name }}</label>
                <div class="product-page__option-btns" role="radiogroup" aria-label="{{ option.name }}">
                  {%- for value in option.values -%}
                    <label class="product-page__option-item{% if option.selected_value == value %} active{% endif %}">
                      <input type="radio" name="options[{{ option.name }}]" value="{{ value }}" id="option-{{ forloop.parentloop.index }}-{{ forloop.index }}"{% if option.selected_value == value %} checked{% endif %}>
                      <span>{{ value }}</span>
                    </label>
                  {%- endfor -%}
                </div>
              </div>
            {%- endfor -%}
          {%- endunless -%}
          
          <button type="submit" class="product-page__submit" name="add" id="product-submit-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
            Añadir al carrito — <span class="product-page__submit-price">{{ product.price | money }}</span>
          </button>
        {%- endform -%}
        
        {%- if section.settings.show_payment_icons -%}
          <div class="product-page__payment">
            <p class="product-page__payment-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> Pago 100% seguro</p>
            <div class="product-page__payment-icons">
              {%- for type in shop.enabled_payment_types -%}
                {{ type | payment_type_svg_tag: class: 'payment-icon' }}
              {%- endfor -%}
            </div>
          </div>
        {%- endif -%}
        
        {%- if section.blocks.size > 0 -%}
          <div class="product-page__benefits">
            {%- for block in section.blocks -%}
              {%- case block.type -%}
                {%- when 'benefit' -%}
                  <div class="product-page__benefit" {{ block.shopify_attributes }}>
                    {%- if block.settings.icon == 'shipping' -%}
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                    {%- elsif block.settings.icon == 'shield' -%}
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    {%- elsif block.settings.icon == 'heart' -%}
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    {%- elsif block.settings.icon == 'refresh' -%}
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    {%- else -%}
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    {%- endif -%}
                    <span>
                      {%- if block.settings.title != blank -%}<strong>{{ block.settings.title }}</strong><br>{%- endif -%}
                      {{ block.settings.text }}
                    </span>
                  </div>
                {%- when 'faq' -%}
                  <div class="product-page__faq" {{ block.shopify_attributes }}>
                    <h4 class="product-page__faq-title">{{ block.settings.question }}</h4>
                    <p class="product-page__faq-answer">{{ block.settings.answer }}</p>
                  </div>
              {%- endcase -%}
            {%- endfor -%}
          </div>
        {%- else -%}
          <div class="product-page__benefits">
            <div class="product-page__benefit"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg><span><strong>Envío gratuito</strong><br>España peninsular 24-48h</span></div>
            <div class="product-page__benefit"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg><span><strong>Garantía de satisfacción</strong><br>30 días para devolución</span></div>
            <div class="product-page__benefit"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span><strong>Pieza única</strong><br>Cada cristal es irrepetible</span></div>
          </div>
        {%- endif -%}
      </div>
    </div>
    
    {%- if product.description != blank -%}
      <div class="product-page__description">
        <h3>Sobre esta pieza</h3>
        <div class="product-page__description-content">{{ product.description }}</div>
      </div>
    {%- endif -%}
  </div>

  <!-- Sticky ATC móvil -->
  <div class="product-page__sticky-atc" id="product-sticky-atc">
    <div class="product-page__sticky-atc-content">
      <div class="product-page__sticky-price">
        <span class="product-page__sticky-price-current">{{ product.price | money }}</span>
      </div>
      <button type="button" class="product-page__sticky-btn" id="product-sticky-submit">
        Añadir al carrito
      </button>
    </div>
  </div>
</section>

<style>
.product-page { padding: 100px 0 80px; position: relative; }
.product-page__container { display: grid; grid-template-columns: 1fr; gap: 48px; align-items: start; }
@media (min-width: 1024px) { .product-page__container { grid-template-columns: 1fr 1fr; gap: 64px; } }
.product-page__gallery { position: sticky; top: 100px; }
@media (max-width: 1023px) { .product-page__gallery { position: relative; top: 0; } }
.product-page__main-image { position: relative; background: var(--color-bg-card); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 16px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; }
.product-page__main-image img { width: 100%; height: 100%; object-fit: contain; padding: 24px; transition: opacity var(--transition-base); }
.product-page__glow { position: absolute; inset: 0; background: radial-gradient(circle at center, rgba(153, 102, 204, 0.25), transparent 60%); pointer-events: none; }
.product-page__thumbs { display: flex; gap: 12px; }
.product-page__thumb { width: 72px; height: 72px; border: 2px solid var(--color-border); border-radius: var(--radius-md); overflow: hidden; cursor: pointer; padding: 0; background: var(--color-bg-card); transition: all var(--transition-base); }
.product-page__thumb:hover { border-color: var(--color-primary); }
.product-page__thumb.active { border-color: var(--color-primary); }
.product-page__thumb img { width: 100%; height: 100%; object-fit: cover; }
.product-page__badges { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.product-page__brand { font-size: 0.875rem; letter-spacing: 0.3em; text-transform: uppercase; color: var(--color-text-muted); margin-bottom: 8px; }
.product-page__title { font-size: 2.5rem; font-weight: 300; margin-bottom: 16px; line-height: 1.2; font-family: var(--font-display); }
@media (min-width: 768px) { .product-page__title { font-size: 3rem; } }
.product-page__rating { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.product-page__rating span { font-size: 0.875rem; color: var(--color-text-muted); }
.product-page__price { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
.product-page__price-compare { font-size: 1.125rem; color: var(--color-text-muted); text-decoration: line-through; }
.product-page__price-current { font-size: 2rem; font-weight: 300; font-family: var(--font-display); }
.product-page__option { margin-bottom: 20px; }
.product-page__option-label { font-size: 0.875rem; font-weight: 500; margin-bottom: 10px; display: block; color: var(--color-text-soft); }
.product-page__option-btns { display: flex; gap: 10px; flex-wrap: wrap; }
.product-page__option-item { cursor: pointer; }
.product-page__option-item input { display: none; }
.product-page__option-item span { display: inline-block; padding: 12px 24px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 0.9375rem; font-weight: 500; background: var(--color-bg-card); color: var(--color-text); transition: all var(--transition-base); }
.product-page__option-item:hover span, .product-page__option-item:focus-within span { border-color: var(--color-primary); outline: none; }
.product-page__option-item.active span { background: var(--color-primary); border-color: var(--color-primary); color: white; }
.product-page__submit { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; background: var(--color-primary); color: white; border: none; padding: 20px 32px; font-size: 1.0625rem; font-weight: 600; border-radius: var(--radius-md); cursor: pointer; margin-bottom: 20px; transition: all var(--transition-base); }
.product-page__submit:hover:not(:disabled), .product-page__submit:focus:not(:disabled) { background: var(--color-primary-dark); box-shadow: var(--shadow-glow); outline: none; }
.product-page__submit:disabled, .product-page__submit.is-disabled { opacity: 0.6; cursor: not-allowed; }
.product-page__payment { background: var(--color-bg-card); border-radius: var(--radius-lg); padding: 24px; text-align: center; margin-bottom: 20px; border: 1px solid var(--color-border); }
.product-page__payment-label { display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9375rem; font-weight: 500; margin-bottom: 16px; }
.product-page__payment-label svg { color: var(--color-success); }
.product-page__payment-icons { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
.product-page__benefits { border: 1px solid var(--color-border); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 20px; }
.product-page__benefit { display: flex; align-items: center; gap: 14px; padding: 16px 20px; background: var(--color-bg-card); border-bottom: 1px solid var(--color-border); }
.product-page__benefit:last-child { border-bottom: none; }
.product-page__benefit svg { flex-shrink: 0; color: var(--color-primary); }
.product-page__benefit strong { display: block; font-size: 0.9375rem; margin-bottom: 2px; }
.product-page__benefit span { font-size: 0.8125rem; color: var(--color-text-soft); }
.product-page__faq { padding: 20px; background: var(--color-bg-card); border-bottom: 1px solid var(--color-border); }
.product-page__faq:last-child { border-bottom: none; }
.product-page__faq-title { font-size: 1rem; font-weight: 500; margin-bottom: 8px; color: var(--color-text); font-family: var(--font-main); }
.product-page__faq-answer { font-size: 0.875rem; line-height: 1.6; color: var(--color-text-soft); }
.product-page__description { max-width: 800px; margin: 60px auto 0; padding: 32px; background: var(--color-bg-card); border-radius: var(--radius-lg); border: 1px solid var(--color-border); }
.product-page__description h3 { font-size: 1.25rem; font-weight: 400; margin-bottom: 16px; font-family: var(--font-main); }
.product-page__description-content { font-size: 0.9375rem; line-height: 1.8; color: var(--color-text-soft); }
.product-page__description-content h2, .product-page__description-content h3, .product-page__description-content h4 { margin-top: 24px; margin-bottom: 12px; color: var(--color-text); }
.product-page__description-content p { margin-bottom: 16px; }
.product-page__description-content ul, .product-page__description-content ol { margin: 16px 0; padding-left: 24px; }
.product-page__description-content li { margin-bottom: 8px; }

/* Sticky ATC móvil */
.product-page__sticky-atc { position: fixed; bottom: 0; left: 0; right: 0; background: var(--color-bg); border-top: 1px solid var(--color-border); padding: 12px var(--space-5); z-index: 90; transform: translateY(100%); transition: transform var(--transition-base); box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3); display: none; }
@media (max-width: 1023px) { .product-page__sticky-atc { display: block; } }
.product-page__sticky-atc.is-visible { transform: translateY(0); }
.product-page__sticky-atc-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; gap: 16px; }
.product-page__sticky-price { flex: 1; }
.product-page__sticky-price-current { font-size: 1.5rem; font-weight: 300; font-family: var(--font-display); color: var(--color-text); }
.product-page__sticky-btn { flex: 2; background: var(--color-primary); color: white; border: none; padding: 14px 24px; font-size: 1rem; font-weight: 600; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); }
.product-page__sticky-btn:hover, .product-page__sticky-btn:focus { background: var(--color-primary-dark); box-shadow: var(--shadow-glow); outline: none; }
.product-page__sticky-btn:disabled { opacity: 0.6; cursor: not-allowed; }
</style>

<script id="product-json" type="application/json">
{
  "id": {{ product.id | json }},
  "title": {{ product.title | json }},
  "handle": {{ product.handle | json }},
  "variants": [
    {%- for variant in product.variants -%}
      {
        "id": {{ variant.id | json }},
        "title": {{ variant.title | json }},
        "price": {{ variant.price | json }},
        "compare_at_price": {{ variant.compare_at_price | json }},
        "available": {{ variant.available | json }},
        "options": {{ variant.options | json }},
        "featured_image": {%- if variant.featured_image -%}{{ variant.featured_image | image_url: width: 800 | json }}{%- else -%}null{%- endif -%},
        "sku": {{ variant.sku | json }}
      }{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  ]
}
</script>

<script>
(function() {
  'use strict';

  // Inicializar sticky ATC
  function initStickyATC() {
    var stickyATC = document.getElementById('product-sticky-atc');
    var stickyBtn = document.getElementById('product-sticky-submit');
    var mainSubmit = document.getElementById('product-submit-btn');
    var productForm = document.getElementById('product-form');

    if (!stickyATC || !stickyBtn || !mainSubmit) return;

    // Mostrar sticky ATC cuando se hace scroll
    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (!entry.isIntersecting) {
          stickyATC.classList.add('is-visible');
        } else {
          stickyATC.classList.remove('is-visible');
        }
      });
    }, { threshold: 0.1 });

    var mainSubmitObserve = document.querySelector('.product-page__submit');
    if (mainSubmitObserve) {
      observer.observe(mainSubmitObserve);
    }

    // Click en sticky button
    stickyBtn.addEventListener('click', function(e) {
      e.preventDefault();
      if (mainSubmit && !mainSubmit.disabled) {
        mainSubmit.click();
      }
    });

    // Sincronizar estado disabled
    if (mainSubmit) {
      var syncDisabled = function() {
        stickyBtn.disabled = mainSubmit.disabled || mainSubmit.classList.contains('is-disabled');
      };
      syncDisabled();
      
      var mutationObserver = new MutationObserver(syncDisabled);
      mutationObserver.observe(mainSubmit, { attributes: true, attributeFilter: ['disabled', 'class'] });
    }
  }

  // Sincronizar precio en sticky ATC
  function syncStickyPrice() {
    var priceCurrent = document.querySelector('.product-page__price-current');
    var stickyPrice = document.querySelector('.product-page__sticky-price-current');
    if (priceCurrent && stickyPrice) {
      stickyPrice.textContent = priceCurrent.textContent;
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    initStickyATC();
    syncStickyPrice();
    
    // Sincronizar precio cuando cambie
    var priceObserver = new MutationObserver(syncStickyPrice);
    var priceCurrent = document.querySelector('.product-page__price-current');
    if (priceCurrent) {
      priceObserver.observe(priceCurrent, { childList: true, characterData: true, subtree: true });
    }
  });
})();
</script>

{{ 'product.js' | asset_url | script_tag }}

{% schema %}
{
  "name": "Product Page",
  "settings": [
    {
      "type": "header",
      "content": "Opciones de visualización"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Mostrar valoración",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_badges",
      "label": "Mostrar badges",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_payment_icons",
      "label": "Mostrar iconos de pago",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "benefit",
      "name": "Beneficio",
      "settings": [
        {
          "type": "select",
          "id": "icon",
          "label": "Icono",
          "options": [
            { "value": "shipping", "label": "Envío" },
            { "value": "shield", "label": "Escudo/Garantía" },
            { "value": "heart", "label": "Corazón/Único" },
            { "value": "refresh", "label": "Devolución" },
            { "value": "info", "label": "Información" }
          ],
          "default": "info"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Título",
          "default": "Beneficio"
        },
        {
          "type": "text",
          "id": "text",
          "label": "Texto",
          "default": "Descripción del beneficio"
        }
      ]
    },
    {
      "type": "faq",
      "name": "Pregunta frecuente",
      "settings": [
        {
          "type": "text",
          "id": "question",
          "label": "Pregunta",
          "default": "¿Pregunta frecuente?"
        },
        {
          "type": "textarea",
          "id": "answer",
          "label": "Respuesta",
          "default": "Respuesta a la pregunta frecuente."
        }
      ]
    }
  ],
  "default": {
    "blocks": [
      {
        "type": "benefit",
        "settings": {
          "icon": "shipping",
          "title": "Envío gratuito",
          "text": "España peninsular 24-48h"
        }
      },
      {
        "type": "benefit",
        "settings": {
          "icon": "shield",
          "title": "Garantía de satisfacción",
          "text": "30 días para devolución"
        }
      },
      {
        "type": "benefit",
        "settings": {
          "icon": "heart",
          "title": "Pieza única",
          "text": "Cada cristal es irrepetible"
        }
      }
    ]
  }
}
{% endschema %}
