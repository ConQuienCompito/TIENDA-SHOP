<section class="cart-page">
  <div class="page-width page-width--narrow">
    <h1 class="cart-page__title">Tu carrito</h1>
    
    {%- if cart.item_count > 0 -%}
      <form action="/cart" method="post" class="cart-page__form" id="cart-form">
        <div class="cart-page__items">
          {%- for item in cart.items -%}
            <div class="cart-page__item" data-line="{{ forloop.index }}" data-key="{{ item.key }}">
              <a href="{{ item.url }}" class="cart-page__item-image">
                {%- if item.image -%}
                  <img src="{{ item.image | image_url: width: 200 }}" alt="{{ item.product.title | escape }}" loading="lazy">
                {%- endif -%}
              </a>
              <div class="cart-page__item-info">
                <a href="{{ item.url }}" class="cart-page__item-title">{{ item.product.title }}</a>
                {%- unless item.product.has_only_default_variant -%}
                  <p class="cart-page__item-variant">{{ item.variant.title }}</p>
                {%- endunless -%}
                <div class="cart-page__item-price">{{ item.final_line_price | money }}</div>
              </div>
              <div class="cart-page__item-qty">
                <div class="cart-page__qty-controls">
                  <button type="button" class="cart-page__qty-btn" data-action="decrease" aria-label="Disminuir cantidad">−</button>
                  <input type="number" name="updates[]" value="{{ item.quantity }}" min="0" max="99" class="cart-page__qty-input" data-line="{{ forloop.index }}" aria-label="Cantidad">
                  <button type="button" class="cart-page__qty-btn" data-action="increase" aria-label="Aumentar cantidad">+</button>
                </div>
                <button type="button" class="cart-page__item-remove" data-action="remove" aria-label="Eliminar {{ item.product.title }}">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
              </div>
            </div>
          {%- endfor -%}
        </div>
        
        <div class="cart-page__footer">
          <div class="cart-page__subtotal">
            <span>Subtotal</span>
            <span id="cart-subtotal">{{ cart.total_price | money }}</span>
          </div>
          <p class="cart-page__note">Impuestos incluidos. Gastos de envío calculados en el checkout.</p>
          <div class="cart-page__actions">
            <a href="/collections/all" class="btn btn--secondary">Seguir comprando</a>
            <button type="submit" name="update" class="btn btn--secondary" id="cart-update-btn">Actualizar carrito</button>
            <a href="/checkout" class="btn btn--primary btn--large">Finalizar compra</a>
          </div>
        </div>
      </form>
    {%- else -%}
      <div class="cart-page__empty">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
        <h2>Tu carrito está vacío</h2>
        <p>Descubre nuestras lámparas de cristal de amatista</p>
        <a href="/collections/all" class="btn btn--primary btn--large">Ver colección</a>
      </div>
    {%- endif -%}
  </div>
</section>

<style>
.cart-page { padding: 100px 0 80px; }
.cart-page__title { font-size: 2rem; font-weight: 300; margin-bottom: 40px; text-align: center; }
.cart-page__items { display: flex; flex-direction: column; gap: 16px; margin-bottom: 40px; }
.cart-page__item { display: grid; grid-template-columns: 100px 1fr auto; gap: 16px; padding: 16px; background: var(--color-bg-card); border-radius: 12px; border: 1px solid var(--color-border); align-items: center; }
@media (max-width: 600px) { .cart-page__item { grid-template-columns: 80px 1fr; gap: 12px; } .cart-page__item-qty { grid-column: 1 / -1; } }
.cart-page__item-image { width: 100px; height: 100px; border-radius: 8px; overflow: hidden; background: var(--color-bg-soft); }
@media (max-width: 600px) { .cart-page__item-image { width: 80px; height: 80px; } }
.cart-page__item-image img { width: 100%; height: 100%; object-fit: cover; }
.cart-page__item-info { display: flex; flex-direction: column; min-width: 0; }
.cart-page__item-title { font-size: 1rem; font-weight: 500; margin-bottom: 4px; display: block; color: var(--color-text); }
.cart-page__item-variant { font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 8px; }
.cart-page__item-price { font-size: 1rem; font-weight: 600; color: var(--color-text); }
.cart-page__item-qty { display: flex; align-items: center; gap: 12px; }
.cart-page__qty-controls { display: flex; align-items: center; gap: 8px; background: var(--color-bg-soft); border-radius: 8px; padding: 4px; }
.cart-page__qty-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: 6px; color: var(--color-text); font-size: 1.125rem; font-weight: 600; cursor: pointer; transition: all var(--transition-base); }
.cart-page__qty-btn:hover { background: var(--color-primary); border-color: var(--color-primary); color: white; }
.cart-page__qty-input { width: 50px; padding: 8px; text-align: center; background: transparent; border: none; color: var(--color-text); font-size: 0.9375rem; font-weight: 500; -moz-appearance: textfield; }
.cart-page__qty-input::-webkit-outer-spin-button, .cart-page__qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
.cart-page__item-remove { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: var(--color-bg-soft); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text-muted); cursor: pointer; transition: all var(--transition-base); }
.cart-page__item-remove:hover { background: var(--color-error); border-color: var(--color-error); color: white; }
.cart-page__footer { background: var(--color-bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--color-border); }
.cart-page__subtotal { display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: 500; margin-bottom: 8px; color: var(--color-text); }
.cart-page__note { font-size: 0.875rem; color: var(--color-text-muted); margin-bottom: 24px; text-align: center; }
.cart-page__actions { display: flex; flex-direction: column; gap: 12px; }
@media (min-width: 600px) { .cart-page__actions { flex-direction: row; justify-content: space-between; } }
.cart-page__empty { text-align: center; padding: 60px 20px; color: var(--color-text-muted); }
.cart-page__empty svg { margin-bottom: 24px; color: var(--color-text-muted); }
.cart-page__empty h2 { font-size: 1.5rem; font-weight: 300; margin-bottom: 8px; color: var(--color-text); }
.cart-page__empty p { margin-bottom: 24px; font-size: 1rem; }
</style>

<script>
(function() {
  var cartForm = document.getElementById('cart-form');
  if (!cartForm) return;

  var CartPage = {
    init: function() {
      // Botones de cantidad
      cartForm.querySelectorAll('[data-action="increase"], [data-action="decrease"]').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          var item = this.closest('.cart-page__item');
          var input = item.querySelector('.cart-page__qty-input');
          var currentQty = parseInt(input.value) || 0;
          var newQty = this.dataset.action === 'increase' ? currentQty + 1 : Math.max(0, currentQty - 1);
          input.value = newQty;
          
          if (newQty === 0) {
            CartPage.removeItem(item);
          } else {
            CartPage.updateCart();
          }
        });
      });

      // Botón eliminar
      cartForm.querySelectorAll('[data-action="remove"]').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          var item = this.closest('.cart-page__item');
          CartPage.removeItem(item);
        });
      });

      // Input de cantidad
      cartForm.querySelectorAll('.cart-page__qty-input').forEach(function(input) {
        input.addEventListener('change', function() {
          var qty = parseInt(this.value) || 0;
          if (qty < 0) qty = 0;
          this.value = qty;
          
          if (qty === 0) {
            var item = this.closest('.cart-page__item');
            CartPage.removeItem(item);
          } else {
            CartPage.updateCart();
          }
        });
      });
    },

    removeItem: function(item) {
      var line = parseInt(item.dataset.line);
      if (window.LUMEI && window.LUMEI.Cart) {
        window.LUMEI.Cart.remove(line)
          .then(function() {
            location.reload();
          })
          .catch(function(err) {
            if (window.LUMEI && window.LUMEI.utils) {
              window.LUMEI.utils.showNotification(err.message || 'Error al eliminar el producto', 'error');
            }
          });
      } else {
        item.remove();
        CartPage.updateCart();
      }
    },

    updateCart: function() {
      var updateBtn = document.getElementById('cart-update-btn');
      if (updateBtn) {
        updateBtn.click();
      }
    }
  };

  document.addEventListener('DOMContentLoaded', function() {
    CartPage.init();
  });
})();
</script>

{% schema %}
{
  "name": "Cart Page",
  "settings": [
    {
      "type": "text",
      "id": "empty_title",
      "label": "Título cuando está vacío",
      "default": "Tu carrito está vacío"
    },
    {
      "type": "text",
      "id": "empty_text",
      "label": "Texto cuando está vacío",
      "default": "Descubre nuestras lámparas de cristal de amatista"
    }
  ]
}
{% endschema %}
